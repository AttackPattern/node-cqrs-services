"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_koaRouter=require("koa-router"),_koaRouter2=_interopRequireDefault(_koaRouter),_passportLocal=require("passport-local"),AuthenticationRouter=function(e){function t(e){var r=this,n=e.passport,a=e.authStore,o=e.decorateUser,u=e.authTokenMapper,s=e.passwordHandler;(0,_classCallCheck3.default)(this,t);var i=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));return i.authenticate=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,n,a){var o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.authStore.checkLogin(t,n);case 2:o=e.sent,a(!o&&"User not found",o);case 4:case"end":return e.stop()}},e,r)}));return function(t,r,n){return e.apply(this,arguments)}}(),i.authStore=a,n.use(new _passportLocal.Strategy({session:!1,passReqToCallback:!1},i.authenticate)),i.post("/resetPassword",s.handleResetCommand).post("/changePassword",s.handleChangeCommand).post("/login",function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,a){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.authenticate("local",function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(n,a,s){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n){e.next=5;break}return console.log("Authentication failure",n),t.status=401,t.body={error:"Invalid username or password"},e.abrupt("return");case 5:return e.t0=_extends3.default,e.t1={},e.t2=a,e.t3={token:u.sign(a)},e.next=11,o(a);case 11:e.t4=e.sent,t.body=(0,e.t0)(e.t1,e.t2,e.t3,e.t4),t.status=200;case 14:case"end":return e.stop()}},e,r)}));return function(t,r,n){return e.apply(this,arguments)}}())(t,a));case 1:case"end":return e.stop()}},e,r)}));return function(t,r){return e.apply(this,arguments)}}()),i}return(0,_inherits3.default)(t,e),t}(_koaRouter2.default);exports.default=AuthenticationRouter,module.exports=exports.default;
//# sourceMappingURL=../maps/routing/authenticationRouter.js.map
