"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_koaRouter=require("koa-router"),_koaRouter2=_interopRequireDefault(_koaRouter),_passportLocal=require("passport-local"),AuthenticationRouter=function(e){function t(e){var r=this,a=e.passport,n=e.authStore,o=e.userProfiles,u=e.getVendor,s=e.authTokenMapper,i=e.passwordHandler;(0,_classCallCheck3.default)(this,t);var l=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));return l.authenticate=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,a,n){var o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.authStore.checkLogin(t,a);case 2:o=e.sent,n(!o&&"User not found",o);case 4:case"end":return e.stop()}},e,r)}));return function(t,r,a){return e.apply(this,arguments)}}(),l.authStore=n,a.use(new _passportLocal.Strategy({session:!1,passReqToCallback:!1},l.authenticate)),l.post("/resetPassword",i.handleResetCommand).post("/changePassword",i.handleChangeCommand).post("/login",function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,n){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",a.authenticate("local",function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(a,n,i){var l;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!a){e.next=5;break}return console.log("Authentication failure",a),t.status=401,t.body={error:"Invalid username or password"},e.abrupt("return");case 5:if(e.t0=n.claims.vendorId,!e.t0){e.next=10;break}return e.next=9,u(n.claims.vendorId);case 9:e.t0=e.sent;case 10:return l=e.t0,e.t1=_extends3.default,e.t2={},e.t3=n,e.t4=s.sign(n),e.next=17,o.getProfile(n.userId);case 17:e.t5=e.sent,e.t6=l&&{companyName:l.companyName,capabilities:l.capabilities,phone:l.phone,homeLocation:l.homeLocation,incidentDetails:l.incidentDetails,reportEmail:l.reportEmail},e.t7={token:e.t4,profile:e.t5,vendor:e.t6},t.body=(0,e.t1)(e.t2,e.t3,e.t7),t.status=200;case 22:case"end":return e.stop()}},e,r)}));return function(t,r,a){return e.apply(this,arguments)}}())(t,n));case 1:case"end":return e.stop()}},e,r)}));return function(t,r){return e.apply(this,arguments)}}()),l}return(0,_inherits3.default)(t,e),t}(_koaRouter2.default);exports.default=AuthenticationRouter,module.exports=exports.default;
//# sourceMappingURL=../maps/routing/authenticationRouter.js.map
