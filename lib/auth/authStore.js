"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _bcrypt=_interopRequireDefault(require("bcrypt")),_v=_interopRequireDefault(require("uuid/v4")),_authStoreInitializer=_interopRequireDefault(require("./authStoreInitializer"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){var t=[],n=!0,a=!1,s=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){a=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw s}}return t}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(e){_defineProperty(r,e,t[e])})}return r}function asyncGeneratorStep(e,r,t,n,a,s,u){try{var o=e[s](u),i=o.value}catch(e){return void t(e)}o.done?r(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(o){return function(){var e=this,u=arguments;return new Promise(function(r,t){var n=o.apply(e,u);function a(e){asyncGeneratorStep(n,r,t,a,s,"next",e)}function s(e){asyncGeneratorStep(n,r,t,a,s,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var saltRounds=10,AuthStore=function e(){var p=this;_classCallCheck(this,e),_defineProperty(this,"addUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,u,o,i,c,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.username,a=r.password,s=r.claims,u=r.updateClaims,o=void 0===u?function(e){return e}:u,e.prev=1,e.next=4,_bcrypt.default.hash(a,saltRounds);case 4:return i=e.sent,e.next=7,p.Login.where({username:n}).fetch({columns:["id","userId","username","claims","status"]});case 7:if(c=e.sent){e.next=14;break}return f="onboard",e.next=12,(new p.Login).save({userId:t,username:n,password:i,claims:JSON.stringify(_objectSpread({},s,o({}))),version:(0,_v.default)(),status:f});case 12:e.next=17;break;case 14:return f=c.attributes.status,e.next=17,c.save({userId:t,claims:JSON.stringify(_objectSpread({},c.get("claims"),s,o(c.get("claims")||{}))||{}),status:"active",version:(0,_v.default)()},{patch:!0});case 17:return e.abrupt("return",{status:f});case 20:throw e.prev=20,e.t0=e.catch(1),console.log("Failed to add login",e.t0),e.t0;case 24:case"end":return e.stop()}},e,null,[[1,20]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"getUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.version,e.prev=1,e.next=4,p.Login.where(n?{username:t,version:n}:{username:t}).query();case 4:return a=e.sent,(s=a.length&&a[0])&&(s.claims=s.claims||{roles:[]}),e.abrupt("return",s?p.getIdentity(s):null);case 10:return e.prev=10,e.t0=e.catch(1),console.log("Could not find user",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}},e,null,[[1,10]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"removeUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.next=3,p.Login.where({userId:t}).fetch({columns:["id","userId","claims","status"]});case 3:if("onboard"===(n=e.sent).attributes.status)return e.abrupt("return",p.Login.where({userId:n.attributes.userId}).destroy());e.next=6;break;case 6:return e.next=8,n.save({userId:t,status:"suspended",claims:JSON.stringify(_objectSpread({},n.get("claims"),{organizations:{}})||{})},{patch:!0});case 8:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"removeUserFromOrg",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.organizationId,n=r.userId,e.next=3,p.Login.where({userId:n}).fetch({columns:["id","userId","claims","status"]});case 3:if("onboard"===(a=e.sent).attributes.status)return e.abrupt("return",p.Login.where({userId:a.attributes.userId}).destroy());e.next=6;break;case 6:return delete(s=_objectSpread({},a.get("claims").organizations))[t],e.next=10,a.save({userId:n,claims:JSON.stringify(_objectSpread({},a.get("claims"),{organizations:s})||{})},{patch:!0});case 10:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"checkLogin",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.password,e.next=3,p.Login.where({username:t}).where("status","<>","suspended").query();case 3:if(a=e.sent,s=a.length&&a[0],e.t0=s,e.t0)return e.next=9,_bcrypt.default.compare(n,s.password);e.next=10;break;case 9:e.t0=e.sent;case 10:if(e.t0)return e.abrupt("return",_objectSpread({},p.getIdentity(s),{status:s.status}));e.next=12;break;case 12:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"changePassword",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.password,a=r.status,e.next=3,_bcrypt.default.hash(n,saltRounds);case 3:return s=e.sent,e.next=6,p.Login.where({userId:t}).fetch();case 6:return u=e.sent,e.next=9,u.save({password:s,version:(0,_v.default)(),status:a||"active"},{patch:!0});case 9:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"enableUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.abrupt("return",p._setUserStatus({userId:t,status:"active"}));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"suspendUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.abrupt("return",p._setUserStatus({userId:t,status:"suspended"}));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"_setUserStatus",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.status,e.prev=1,e.next=4,p.Login.where({userId:t}).fetch();case 4:return a=e.sent,e.next=7,a.save({status:n,version:(0,_v.default)()},{patch:!0});case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),console.log("Error setting user status",e.t0),e.t0;case 13:case"end":return e.stop()}},e,null,[[1,9]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"count",function(){return p.Login.count()})};function merge(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return Object.entries(r).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=Array.isArray(a)?Array.from(new Set(e[n]?a.concat(e[n]):a)):a,e},e)}_defineProperty(exports.default=AuthStore,"create",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.db,n=r.identityMapper,e.next=3,_authStoreInitializer.default.assureTables(t);case 3:return(a=new AuthStore).getIdentity=function(e){return n(e)},a.Login=require("bookshelf")(t.knex("auth")).Model.extend({tableName:"logins"}),e.abrupt("return",a);case 7:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}());
//# sourceMappingURL=../maps/auth/authStore.js.map
