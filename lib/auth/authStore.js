"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _bcrypt=_interopRequireDefault(require("bcrypt")),_v=_interopRequireDefault(require("uuid/v4")),_speakeasy=_interopRequireDefault(require("speakeasy")),_authStoreInitializer=_interopRequireDefault(require("./authStoreInitializer"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function asyncGeneratorStep(e,r,t,n,a,s,o){try{var u=e[s](o),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(u){return function(){var e=this,o=arguments;return new Promise(function(r,t){var n=u.apply(e,o);function a(e){asyncGeneratorStep(n,r,t,a,s,"next",e)}function s(e){asyncGeneratorStep(n,r,t,a,s,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var saltRounds=10,AuthStore=function e(){var d=this;_classCallCheck(this,e),_defineProperty(this,"addUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,o,u,i,c,p,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.username,a=r.password,s=r.claims,o=r.updateClaims,u=void 0===o?function(e){return e}:o,i=r.status,c=void 0===i?"active":i,e.prev=1,e.next=4,_bcrypt.default.hash(a,saltRounds);case 4:return p=e.sent,e.next=7,d.Login.where({username:n}).fetch({columns:["id","userId","username","claims"]});case 7:if(f=e.sent){e.next=14;break}return e.next=11,(new d.Login).save({userId:t,username:n,password:p,claims:JSON.stringify(_objectSpread({},s,{},u({}))),version:(0,_v.default)(),status:c});case 11:return e.next=13,d.getUser({username:n});case 13:return e.abrupt("return",e.sent);case 14:return e.next=16,f.save({userId:t,claims:JSON.stringify(_objectSpread({},f.get("claims"),{},s,{},u(f.get("claims")||{}))||{}),version:(0,_v.default)()},{patch:!0});case 16:e.next=22;break;case 18:throw e.prev=18,e.t0=e.catch(1),console.log("Failed to add login",e.t0),e.t0;case 22:case"end":return e.stop()}},e,null,[[1,18]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"enable2fa",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,o,u=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=1<u.length&&void 0!==u[1]?u[1]:{},e.next=4,d.Login.where({username:t}).fetch({columns:["id","userId","enabled2FA","secret"]});case 4:if(a=e.sent,s=a.toJSON(),!a||null!=s&&s.enabled2FA)throw new Error(s?"2FA is already enabled/pending for this account":"User doesn't exist");e.next=8;break;case 8:return o=_speakeasy.default.generateSecret(n),e.next=11,a.save({secret:o.base32});case 11:return e.abrupt("return",{userId:s.id,qrCodeUrl:o.otpauth_url});case 12:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"confirm2fa",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.totpCode,e.next=3,d.Login.where({username:t}).fetch({columns:["id","userId","secret","enabled2FA"]});case 3:if(a=e.sent,(s=a.toJSON())&&null!=s&&s.secret){e.next=7;break}throw new Error(s?"no secret present to verify against":"User doesn't exist");case 7:if(_speakeasy.default.totp.verify({secret:s.secret,encoding:"base32",token:n}))return e.next=11,a.save({enabled2FA:!0});e.next=14;break;case 11:return e.abrupt("return",{confirmed:!0});case 14:throw new Error("Confirmation code doesn't match");case 15:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"deactivate2fa",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.totpCode,e.next=3,d.Login.where({username:t}).fetch({columns:["id","userId","secret","enabled2FA"]});case 3:if(a=e.sent,(s=a.toJSON())&&null!=s&&s.secret&&null!=s&&s.enabled2FA){e.next=7;break}throw new Error(s?"2FA not enabled":"User doesn't exist");case 7:if(_speakeasy.default.totp.verify({secret:s.secret,encoding:"base32",token:n,window:6}))return e.next=11,a.save({enabled2FA:!1,secret:""});e.next=14;break;case 11:return e.abrupt("return",{removed:!0});case 14:throw new Error("Confirmation code doesn't match");case 15:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"verify2fa",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.totpCode,e.next=3,d.Login.where({username:t}).where("status","<>","suspended").fetch();case 3:if(a=e.sent,(s=a.toJSON())&&null!=s&&s.secret&&null!=s&&s.enabled2FA){e.next=7;break}throw new Error(s?"2FA not enabled":"User doesn't exist");case 7:if(_speakeasy.default.totp.verify({secret:s.secret,encoding:"base32",token:n,window:6})){e.next=10;break}throw new Error("Incorrect totp code");case 10:return e.abrupt("return",_objectSpread({},d.getIdentity(s),{status:s.status}));case 11:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"toggleFeatures",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.organizationId,n=r.features,e.next=3,d.Feature.where({organizationId:t}).fetch();case 3:if(!(a=e.sent)){e.next=8;break}a.save({claims:JSON.stringify(_objectSpread({},n))}),e.next=10;break;case 8:return e.next=10,(new d.Feature).save({organizationId:t,claims:JSON.stringify(_objectSpread({},n))});case 10:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"getFeatures",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,d.Feature.where({organizationId:r}).query();case 3:return t=e.sent,e.abrupt("return",t||{});case 7:return e.prev=7,e.t0=e.catch(0),console.log("Could not find organization with enabled features",e.t0.message),e.abrupt("return",null);case 11:case"end":return e.stop()}},e,null,[[0,7]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"getUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.version,e.prev=1,e.next=4,d.Login.where(n?{username:t,version:n}:{username:t}).query();case 4:return a=e.sent,(s=a.length&&a[0])&&(s.claims=s.claims||{roles:[]}),e.abrupt("return",s?d.getIdentity(s):null);case 10:return e.prev=10,e.t0=e.catch(1),console.log("Could not find user",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}},e,null,[[1,10]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"updateEmail",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.newEmail,e.prev=1,e.next=4,d.Login.where({userId:t}).fetch();case 4:return a=e.sent,e.next=7,a.save({userId:t,username:n},{patch:!0});case 7:return e.abrupt("return",a);case 10:return e.prev=10,e.t0=e.catch(1),console.log("user not found for email update"),e.abrupt("return",null);case 14:case"end":return e.stop()}},e,null,[[1,10]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"removeUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.next=3,new d.Login({userId:t}).fetch();case 3:return n=e.sent,e.next=6,n.destroy();case 6:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"removeUserFromOrg",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.organizationId,n=r.userId,e.next=3,d.Login.where({userId:n}).fetch({columns:["id","userId","claims"]});case 3:return a=e.sent,delete(s=_objectSpread({},a.get("claims").organizations))[t],e.next=8,a.save({userId:n,claims:JSON.stringify(_objectSpread({},a.get("claims"),{organizations:s})||{})},{patch:!0});case 8:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"checkLogin",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.username,n=r.password,e.next=3,d.Login.where({username:t}).where("status","<>","suspended").query();case 3:if(a=e.sent,s=a.length&&a[0],e.t0=s,e.t0)return e.next=9,_bcrypt.default.compare(n,s.password);e.next=10;break;case 9:e.t0=e.sent;case 10:if(e.t0)return e.abrupt("return",_objectSpread({},d.getIdentity(s),{status:s.status}));e.next=12;break;case 12:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"changePassword",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.password,a=r.status,e.next=3,_bcrypt.default.hash(n,saltRounds);case 3:return s=e.sent,e.next=6,d.Login.where({userId:t}).fetch();case 6:return o=e.sent,e.next=9,o.save({password:s,version:(0,_v.default)(),status:a||"active"},{patch:!0});case 9:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"updateRoles",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s,o,u,i,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.organizationId,a=r.roles,o=null,n||(o="No organizationId provided to updateRoles."),(s=void 0===a?[]:a).length||(o="No roles provided to updateRoles. A user must have at least one role."),e.next=6,d.Login.where({userId:t}).fetch();case 6:if((u=e.sent)||(o="User not found for updateRoles."),(i=_objectSpread({},u.get("claims").organizations))[n]||(o="Organization not found for updateRoles."),o)throw console.log(o),o;e.next=13;break;case 13:return i[n].roles=s,c=u.get("claims")||{},e.next=17,u.save({claims:JSON.stringify(_objectSpread({},c,{organizations:i}))},{patch:!0});case 17:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"enableUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.abrupt("return",d._setUserStatus({userId:t,status:"active"}));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"suspendUser",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,e.abrupt("return",d._setUserStatus({userId:t,status:"suspended"}));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"_setUserStatus",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.userId,n=r.status,e.prev=1,e.next=4,d.Login.where({userId:t}).fetch();case 4:return a=e.sent,e.next=7,a.save({status:n,version:(0,_v.default)()},{patch:!0});case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),console.log("Error setting user status",e.t0),e.t0;case 13:case"end":return e.stop()}},e,null,[[1,9]])}));return function(e){return r.apply(this,arguments)}}()),_defineProperty(this,"count",function(){return d.Login.count()})};_defineProperty(exports.default=AuthStore,"create",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.db,n=r.identityMapper,e.next=3,_authStoreInitializer.default.assureTables(t);case 3:return(a=new AuthStore).getIdentity=function(e){return n(e)},s=require("bookshelf")(t.knex("auth")),a.Login=s.Model.extend({tableName:"logins"}),a.Feature=s.Model.extend({tableName:"features"}),e.abrupt("return",a);case 9:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}());
//# sourceMappingURL=../maps/auth/authStore.js.map
