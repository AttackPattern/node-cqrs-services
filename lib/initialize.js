"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_entries=require("babel-runtime/core-js/object/entries"),_entries2=_interopRequireDefault(_entries),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_awsSdk=require("aws-sdk"),_awsSdk2=_interopRequireDefault(_awsSdk),_commandRouter=require("./routing/commandRouter"),_commandRouter2=_interopRequireDefault(_commandRouter),_uploadRouter=require("./routing/uploadRouter"),_uploadRouter2=_interopRequireDefault(_uploadRouter),_nodeCqrsLib=require("node-cqrs-lib"),_identityMiddleware=require("./routing/identityMiddleware"),_identityMiddleware2=_interopRequireDefault(_identityMiddleware),_commandExecutor=require("./commandHandling/commandExecutor"),_commandExecutor2=_interopRequireDefault(_commandExecutor),_webCommandHandler=require("./commandHandling/webCommandHandler"),_webCommandHandler2=_interopRequireDefault(_webCommandHandler),_domainCommandDeliverer=require("./commandHandling/domainCommandDeliverer"),_domainCommandDeliverer2=_interopRequireDefault(_domainCommandDeliverer),_eventing=require("./eventing"),_services=require("./services"),_configure=require("./scheduling/configure"),_configure2=_interopRequireDefault(_configure),_authTokenMapper=require("./auth/authTokenMapper"),_authTokenMapper2=_interopRequireDefault(_authTokenMapper),_authStore=require("./auth/authStore"),_authStore2=_interopRequireDefault(_authStore),Services=function e(){(0,_classCallCheck3.default)(this,e)};Services.initialize=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,i,u,o,s,d,c,l,_,m,f,p=r.container,w=r.config,g=r.db,v=r.domain,S=r.emailTemplates;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=function(e){return(0,_entries2.default)(e).map(function(e){var r=e[0],t=e[1];return{name:r,handler:function(){return p.resolve(t)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},e.next=3,_eventing.EventStoreInitializer.assureEventsTable(g);case 3:return n=(0,_entries2.default)(v).reduce(function(e,r){var t=r[0],n=r[1];return e[t]=new _nodeCqrsLib.Repository({eventStore:new _eventing.EventStore({aggregate:t,db:g,mapper:new _eventing.EventMapper(t,n.events)}),aggregate:n.aggregate}),e},{}),a=(0,_entries2.default)(v).map(function(e){var r=e[0],a=e[1];return new _commandExecutor2.default({name:r,handlers:t(a.handlers),repository:n[r]})}),i=(0,_entries2.default)(v).reduce(function(e,r){var t=r[0],n=r[1];return e[t]=n.commands,e},{}),e.next=8,_authStore2.default.create(g);case 8:return u=e.sent,o=new _authTokenMapper2.default({authStore:u,secret:w.decrypt(w("authentication").secret),expiration:w("authentication").expiration}),p.register("systemIdentity",function(){return o.sign(_nodeCqrsLib.Identity.system)}),_awsSdk2.default.config.update({region:w("aws").SNS_SES_region,accessKeyId:w.decrypt(w("aws").AccessKey),secretAccessKey:w.decrypt(w("aws").SecretAccessKey)}),s=new _services.AwsSNS({applicationArns:{ios:w("aws").IOS_APP_ARN,android:w("aws").ANDROID_APP_ARN}}),p.register("PushNotifications",function(){return s}),d=new _services.Emailer({sender:new _services.AwsEmailSender({awsSes:new _awsSdk2.default.SES,from:w("aws").SES_Source}),templateLibrary:S}),p.register("Emailer",function(){return d}),c=new _services.SecretCodes,p.register("SecretCodes",function(){return c}),p.register("AuthStore",function(){return u}),l=new _domainCommandDeliverer2.default(a),_=(0,_configure2.default)({db:g,deliverer:l,commands:i,repositories:n}),p.register("DomainServices",function(){return _}),m=new _uploadRouter2.default({S3_Bucket:w("aws").S3_Bucket}),f=new _commandRouter2.default({webHandler:new _webCommandHandler2.default(l)}),e.abrupt("return",{routers:{upload:m,command:f},middleware:[new _identityMiddleware2.default(o).inject],authStore:u,repositories:n});case 25:case"end":return e.stop()}},e,void 0)}));return function(r){return e.apply(this,arguments)}}(),exports.default=Services,module.exports=exports.default;
//# sourceMappingURL=maps/initialize.js.map
