"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){var n=[],t=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(t=(o=u.next()).done)&&(n.push(o.value),!r||n.length!==r);t=!0);}catch(e){a=!0,i=e}finally{try{t||null==u.return||u.return()}finally{if(a)throw i}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,r,n,t,a,i,o){try{var u=e[i](o),s=u.value}catch(e){return void n(e)}u.done?r(s):Promise.resolve(s).then(t,a)}function _asyncToGenerator(e){return function(){var r=this,n=arguments;return new Promise(function(t,a){function i(e){asyncGeneratorStep(u,t,a,i,o,"next",e)}function o(e){asyncGeneratorStep(u,t,a,i,o,"throw",e)}var u=e.apply(r,n);i(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk")),_koaPassport=_interopRequireDefault(require("koa-passport")),_amqplib=_interopRequireDefault(require("amqplib")),_authenticationRouter=_interopRequireDefault(require("./routing/authenticationRouter")),_commandRouter=_interopRequireDefault(require("./routing/commandRouter")),_identityMiddleware=_interopRequireDefault(require("./routing/identityMiddleware")),_commandExecutor=_interopRequireDefault(require("./commandHandling/commandExecutor")),_webCommandHandler=_interopRequireDefault(require("./commandHandling/webCommandHandler")),_passwordCommandHandler=_interopRequireDefault(require("./commandHandling/passwordCommandHandler")),_domainCommandDeliverer=_interopRequireDefault(require("./commandHandling/domainCommandDeliverer")),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=_interopRequireDefault(require("./auth/authTokenMapper")),_authStore=_interopRequireDefault(require("./auth/authStore")),_nodeCqrsLib=require("@facetdev/node-cqrs-lib"),_domainServices=_interopRequireDefault(require("./scheduling/domainServices")),Services=function e(){_classCallCheck(this,e)};exports.default=Services,_defineProperty(Services,"initialize",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t,a,i,o,u,s,c,d,l,f,m,p,_,w,v,h,y,S,g,b,q,R,C,A,T;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return g=function(e){return new Promise(function(r){function n(){_amqplib.default.connect(e).then(function(e){console.log("Connected to rabbit"),r(e)}).catch(function(){setTimeout(n,500)})}n()})},c=function(e){return Object.entries(e).map(function(e){var r=e[0],t=e[1];return{name:r,handler:function(){return n.resolve(t)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},n=r.container,t=r.config,a=r.db,i=r.domain,o=r.emailTemplates,u=r.decorateUser,s=void 0===u?function(e){return e}:u,e.next=5,_eventing.EventStoreInitializer.assureEventsTable(a);case 5:return d=new _eventing.EventMapper(Object.entries(i).reduce(function(e,r){var n=_slicedToArray(r,2),t=n[0],a=n[1];return e[t]=a.events,e},{})),l=Object.entries(i).reduce(function(e,r){var n=_slicedToArray(r,2),i=n[0],o=n[1];return e[i]=new _nodeCqrsLib.Repository({eventStore:new _eventing.EventStore({aggregate:i,db:a,mapper:d}),aggregateType:i,constructor:o.aggregate,snapshots:t("eventStore").snapshots}),e},{}),f=Object.entries(i).map(function(e){var r=_slicedToArray(e,2),n=r[0],t=r[1];return new _commandExecutor.default({name:n,handlers:c(t.handlers),repository:l[n]})}),e.next=10,_authStore.default.create({db:a,roleMapping:new _nodeCqrsLib.RoleMapping(t("roles").roles)});case 10:return m=e.sent,p=new _authTokenMapper.default({authStore:m,secret:t.decrypt(t("authentication").secret),expiration:t("authentication").expiration}),n.register("systemIdentity",function(){return p.sign(_nodeCqrsLib.Identity.system)}),_awsSdk.default.config.update({region:t("aws").SNS_SES_region,accessKeyId:t("aws").AccessKey&&t.decrypt(t("aws").AccessKey),secretAccessKey:t("aws").SecretAccessKey&&t.decrypt(t("aws").SecretAccessKey)}),_=new _services.AwsSNS({applicationArns:{ios:t("aws").IOS_APP_ARN,android:t("aws").ANDROID_APP_ARN}}),n.register("PushNotifications",function(){return _}),w={sendEmail:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.recipient,t=r.subject,a=r.body,console.log("Simulating Sending Email\n  ---------------------\n  ".concat(t,"\n  To: ").concat(n,"\n  ---------------------\n  ").concat(a.text));case 2:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},v=new _services.Emailer({sender:(t("aws").Test||[]).includes("email")?w:new _services.AwsEmailSender({awsSes:new _awsSdk.default.SES,from:t("aws").SES_Source}),templateLibrary:o}),n.register("Emailer",function(){return v}),h=new _services.SecretCodes,n.register("SecretCodes",function(){return h}),n.register("AuthStore",function(){return m}),y=new _domainCommandDeliverer.default(f),S=new _nodeCqrsLib.RealWorldClock,e.next=26,g(t("scheduledCommands").store);case 26:return e.next=28,e.sent.createChannel();case 28:return b=e.sent,q=new _nodeCqrsLib.RabbitScheduler({channel:b,clock:S,deliverer:y}),R=new _domainServices.default({commandScheduler:q,repositories:l,clock:S}),n.register("DomainServices",function(){return R}),C=new _commandRouter.default({webHandler:new _webCommandHandler.default(y)}),A=new _passwordCommandHandler.default(y,m),T=new _authenticationRouter.default({passport:_koaPassport.default,authStore:m,decorateUser:s,authTokenMapper:p,passwordHandler:A}),e.abrupt("return",{routers:{command:C,auth:T},middleware:{identity:new _identityMiddleware.default(p).inject},authStore:m,repositories:l});case 36:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}());
//# sourceMappingURL=maps/initialize.js.map
