"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=this,n=arguments;return new Promise(function(t,a){function i(e,r){try{var n=s[e](r),i=n.value}catch(e){return void a(e)}n.done?t(i):Promise.resolve(i).then(o,u)}function o(e){i("next",e)}function u(e){i("throw",e)}var s=e.apply(r,n);o()})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk")),_koaPassport=_interopRequireDefault(require("koa-passport")),_authenticationRouter=_interopRequireDefault(require("./routing/authenticationRouter")),_commandRouter=_interopRequireDefault(require("./routing/commandRouter")),_uploadRouter=_interopRequireDefault(require("./routing/uploadRouter")),_nodeCqrsLib=require("node-cqrs-lib"),_identityMiddleware=_interopRequireDefault(require("./routing/identityMiddleware")),_commandExecutor=_interopRequireDefault(require("./commandHandling/commandExecutor")),_webCommandHandler=_interopRequireDefault(require("./commandHandling/webCommandHandler")),_passwordCommandHandler=_interopRequireDefault(require("./commandHandling/passwordCommandHandler")),_domainCommandDeliverer=_interopRequireDefault(require("./commandHandling/domainCommandDeliverer")),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=_interopRequireDefault(require("./auth/authTokenMapper")),_authStore=_interopRequireDefault(require("./auth/authStore")),_scheduledCommandStore=_interopRequireDefault(require("./scheduling/scheduledCommandStore")),_scheduledCommandStoreInitializer=_interopRequireDefault(require("./scheduling/scheduledCommandStoreInitializer")),_domainServices=_interopRequireDefault(require("./scheduling/domainServices")),Services=function e(){_classCallCheck(this,e)};exports.default=Services,Object.defineProperty(Services,"initialize",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t,a,i,o,u,s,c,d,l,m,_,f,p,w,S,h,v,g,q,R,C,y,b,D,k;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=function(e){return Object.entries(e).map(function(e){var r=e[0],t=e[1];return{name:r,handler:function(){return n.resolve(t)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},n=r.container,t=r.config,a=r.db,i=r.domain,o=r.emailTemplates,u=r.decorateUser,e.next=4,_eventing.EventStoreInitializer.assureEventsTable(a);case 4:return e.next=6,_scheduledCommandStoreInitializer.default.assureTables(a);case 6:return c=Object.entries(i).reduce(function(e,r){var n=r[0],t=r[1];return e[n]=new _nodeCqrsLib.Repository({eventStore:new _eventing.EventStore({aggregate:n,db:a,mapper:new _eventing.EventMapper(n,t.events)}),aggregate:t.aggregate}),e},{}),d=Object.entries(i).map(function(e){var r=e[0],n=e[1];return new _commandExecutor.default({name:r,handlers:s(n.handlers),repository:c[r]})}),l=Object.entries(i).reduce(function(e,r){var n=r[0],t=r[1];return e[n]=t.commands,e},{}),e.next=11,_authStore.default.create(a);case 11:return m=e.sent,_=new _authTokenMapper.default({authStore:m,secret:t.decrypt(t("authentication").secret),expiration:t("authentication").expiration}),n.register("systemIdentity",function(){return _.sign(_nodeCqrsLib.Identity.system)}),_awsSdk.default.config.update({region:t("aws").SNS_SES_region,accessKeyId:t("aws").AccessKey&&t.decrypt(t("aws").AccessKey),secretAccessKey:t("aws").SecretAccessKey&&t.decrypt(t("aws").SecretAccessKey)}),f=new _services.AwsSNS({applicationArns:{ios:t("aws").IOS_APP_ARN,android:t("aws").ANDROID_APP_ARN}}),n.register("PushNotifications",function(){return f}),p={sendEmail:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.recipient,t=r.subject,a=r.body,console.log("Simulating Sending Email\n  ---------------------\n  ".concat(t,"\n  To: ").concat(n,"\n  ---------------------\n  ").concat(a.text));case 2:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},w=new _services.Emailer({sender:(t("aws").Test||[]).includes("email")?new _services.AwsEmailSender({awsSes:new _awsSdk.default.SES,from:t("aws").SES_Source}):p,templateLibrary:o}),n.register("Emailer",function(){return w}),S=new _services.SecretCodes,n.register("SecretCodes",function(){return S}),n.register("AuthStore",function(){return m}),h=new _domainCommandDeliverer.default(d),v=new _nodeCqrsLib.RealWorldClock,g=new _scheduledCommandStore.default(a,function(e,r){return l[e][r]},function(){return new _nodeCqrsLib.RealWorldClock}),q=new _nodeCqrsLib.CommandScheduler({store:g,clock:v,deliverer:h}),R=new _nodeCqrsLib.CommandScheduleTrigger(q,v,1e3),R.start(),C=new _domainServices.default({commandScheduler:q,repositories:c,clock:v}),n.register("DomainServices",function(){return C}),y=new _uploadRouter.default({S3_Bucket:t("aws").S3_Bucket}),b=new _commandRouter.default({webHandler:new _webCommandHandler.default(h)}),D=new _passwordCommandHandler.default(h,m),k=new _authenticationRouter.default({passport:_koaPassport.default,authStore:m,decorateUser:u,authTokenMapper:_,passwordHandler:D}),e.abrupt("return",{routers:{upload:y,command:b,auth:k},middleware:{identity:new _identityMiddleware.default(_).inject},authStore:m,repositories:c});case 36:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()});
//# sourceMappingURL=maps/initialize.js.map
