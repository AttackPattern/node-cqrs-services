"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(r){_defineProperty(e,r,t[r])})}return e}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){var t=[],n=!0,a=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(t.push(i.value),!r||t.length!==r);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}return t}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,r,t,n,a,o,i){try{var u=e[o](i),s=u.value}catch(e){return void t(e)}u.done?r(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,a){function o(e){asyncGeneratorStep(u,n,a,o,i,"next",e)}function i(e){asyncGeneratorStep(u,n,a,o,i,"throw",e)}var u=e.apply(r,t);o(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk")),_koaPassport=_interopRequireDefault(require("koa-passport")),_amqplib=_interopRequireDefault(require("amqplib")),_authenticationRouter=_interopRequireDefault(require("./routing/authenticationRouter")),_commandRouter=_interopRequireDefault(require("./routing/commandRouter")),_identityMiddleware=_interopRequireDefault(require("./routing/identityMiddleware")),_commandExecutor=_interopRequireDefault(require("./commandHandling/commandExecutor")),_webCommandHandler=_interopRequireDefault(require("./commandHandling/webCommandHandler")),_passwordCommandHandler=_interopRequireDefault(require("./commandHandling/passwordCommandHandler")),_domainCommandDeliverer=_interopRequireDefault(require("./commandHandling/domainCommandDeliverer")),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=_interopRequireDefault(require("./auth/authTokenMapper")),_authStore=_interopRequireDefault(require("./auth/authStore")),_nodeCqrsLib=require("@facetdev/node-cqrs-lib"),_domainServices=_interopRequireDefault(require("./scheduling/domainServices")),Services=function e(){_classCallCheck(this,e)};exports.default=Services,_defineProperty(Services,"initialize",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,i,u,s,c,d,l,p,f,m,_,v,w,b,y,g,h,S,q,R,x,C,k,A,T;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return q=function(e){return new Promise(function(r){function t(){_amqplib.default.connect(e).then(function(e){console.log("Connected to rabbit"),r(e)}).catch(function(){setTimeout(t,500)})}t()})},d=function(e){return Object.entries(e).map(function(e){var r=e[0],n=e[1];return{name:r,handler:function(){return t.resolve(n)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},t=r.container,n=r.config,a=r.db,o=r.bootstrap,i=r.domain,u=r.emailTemplates,s=r.decorateUser,c=void 0===s?function(e){return e}:s,e.next=5,_eventing.EventStoreInitializer.assureEventsTable(a);case 5:if(l=new _eventing.EventStore({db:a,mapper:new _eventing.EventMapper(Object.entries(i).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=a.events,e},{}))}),e.t0=null===o||void 0===o?void 0:o.events,!e.t0){e.next=12;break}return e.next=10,l.count();case 10:e.t1=e.sent,e.t0=0===e.t1;case 12:if(!e.t0){e.next=17;break}return console.log("bootstrapping events"),p=o.events().reduce(function(e,r){return e.sequence[r.aggregateId]=(e.sequence[r.aggregateId]||0)+1,e.events.push(_objectSpread({},r,{actor:"bootstrap",sequenceNumber:e.sequence[r.aggregateId]})),e},{sequence:{},events:[]}).events,e.next=17,l.record(p.map(function(e){return _objectSpread({},e,{actor:"bootstrap"})}));case 17:return f=Object.entries(i).reduce(function(e,r){var t=_slicedToArray(r,2),a=t[0],o=t[1];return e[a]=new _nodeCqrsLib.Repository({eventStore:l,aggregateType:a,constructor:o.aggregate,snapshots:n("eventStore").snapshots}),e},{}),m=Object.entries(i).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return new _commandExecutor.default({name:t,handlers:d(n.handlers),repository:f[t]})}),e.next=21,_authStore.default.create({db:a,roleMapping:new _nodeCqrsLib.RoleMapping(n("roles").roles)});case 21:if(_=e.sent,e.t2=null===o||void 0===o?void 0:o.users,!e.t2){e.next=28;break}return e.next=26,_.count();case 26:e.t3=e.sent,e.t2=0===e.t3;case 28:if(!e.t2){e.next=32;break}return console.log("bootstrapping users"),e.next=32,Promise.all(o.users().map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_.addLogin(r);case 2:if(e.t0=e.sent,e.t0){e.next=5;break}e.t0=[];case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()));case 32:return v=new _authTokenMapper.default({authStore:_,secret:n.decrypt(n("authentication").secret),expiration:n("authentication").expiration}),t.register("systemIdentity",function(){return v.sign(_nodeCqrsLib.Identity.system)}),_awsSdk.default.config.update({region:n("aws").SNS_SES_region,accessKeyId:n("aws").AccessKey&&n.decrypt(n("aws").AccessKey),secretAccessKey:n("aws").SecretAccessKey&&n.decrypt(n("aws").SecretAccessKey)}),w=new _services.AwsSNS({applicationArns:{ios:n("aws").IOS_APP_ARN,android:n("aws").ANDROID_APP_ARN}}),t.register("PushNotifications",function(){return w}),b={sendEmail:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.recipient,n=r.subject,a=r.body,console.log("Simulating Sending Email\n  ---------------------\n  ".concat(n,"\n  To: ").concat(t,"\n  ---------------------\n  ").concat(a.text));case 2:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},y=new _services.Emailer({sender:(n("aws").Test||[]).includes("email")?b:new _services.AwsEmailSender({awsSes:new _awsSdk.default.SES,from:n("aws").SES_Source}),templateLibrary:u}),t.register("Emailer",function(){return y}),g=new _services.SecretCodes,t.register("SecretCodes",function(){return g}),t.register("AuthStore",function(){return _}),h=new _domainCommandDeliverer.default(m),S=new _nodeCqrsLib.RealWorldClock,e.next=47,q(n("scheduledCommands").store);case 47:return e.next=49,e.sent.createChannel();case 49:return R=e.sent,x=new _nodeCqrsLib.RabbitScheduler({channel:R,clock:S,deliverer:h}),C=new _domainServices.default({commandScheduler:x,repositories:f,clock:S}),t.register("DomainServices",function(){return C}),k=new _commandRouter.default({webHandler:new _webCommandHandler.default(h)}),A=new _passwordCommandHandler.default(h,_),T=new _authenticationRouter.default({passport:_koaPassport.default,authStore:_,decorateUser:c,authTokenMapper:v,passwordHandler:A}),e.abrupt("return",{routers:{command:k,auth:T},middleware:{identity:new _identityMiddleware.default(v).inject},authStore:_,repositories:f});case 57:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}());
//# sourceMappingURL=maps/initialize.js.map
