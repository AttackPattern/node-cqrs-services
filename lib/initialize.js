"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk")),_koaPassport=_interopRequireDefault(require("koa-passport")),_amqplib=_interopRequireDefault(require("amqplib")),_authenticationRouter=_interopRequireDefault(require("./routing/authenticationRouter")),_commandRouter=_interopRequireDefault(require("./routing/commandRouter")),_injectEventRouter=_interopRequireDefault(require("./routing/injectEventRouter")),_identityMiddleware=_interopRequireDefault(require("./routing/identityMiddleware")),_commandExecutor=_interopRequireDefault(require("./commandHandling/commandExecutor")),_webCommandHandler=_interopRequireDefault(require("./commandHandling/webCommandHandler")),_passwordCommandHandler=_interopRequireDefault(require("./commandHandling/passwordCommandHandler")),_domainCommandDeliverer=_interopRequireDefault(require("./commandHandling/domainCommandDeliverer")),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=_interopRequireDefault(require("./auth/authTokenMapper")),_authStore=_interopRequireDefault(require("./auth/authStore")),_nodeCqrsLib=require("@facetdev/node-cqrs-lib"),_domainServices=_interopRequireDefault(require("./scheduling/domainServices"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(e){_defineProperty(r,e,t[e])})}return r}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){var t=[],n=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){a=!0,i=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw i}}return t}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,r,t,n,a,i,o){try{var u=e[i](o),s=u.value}catch(e){return void t(e)}u.done?r(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(u){return function(){var e=this,o=arguments;return new Promise(function(r,t){var n=u.apply(e,o);function a(e){asyncGeneratorStep(n,r,t,a,i,"next",e)}function i(e){asyncGeneratorStep(n,r,t,a,i,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var Services=function e(){_classCallCheck(this,e)};_defineProperty(exports.default=Services,"initialize",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var a,i,t,n,o,u,s,c,d,l,p,f,m,_,v,y,b,w,h,g,S,q,R,x,k,C,A,D,E,T,j,P,O,H,I,M,L,N;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return j=function(t){return new Promise(function(r){!function e(){_amqplib.default.connect(t).then(function(e){console.log("Connected to rabbit"),r(e)}).catch(function(){setTimeout(e,500)})}()})},f=function(e){return Object.entries(e).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return{name:t,handler:function(){return a.resolve(n)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},a=r.container,i=r.config,t=r.db,n=r.bootstrap,o=r.domain,u=r.emailTemplates,s=r.emailSender,c=r.decorateUser,d=void 0===c?function(e){return e}:c,l=r.identityMapper,p=void 0===l?function(e){return new _nodeCqrsLib.Identity(e)}:l,e.next=5,_eventing.EventStoreInitializer.assureEventsTable(t);case 5:if(m=new _eventing.EventStore({db:t,mapper:new _eventing.EventMapper(Object.entries(o).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=a.events,e},{}))}),e.t0=null==n?void 0:n.events,e.t0)return e.next=10,m.count();e.next=12;break;case 10:e.t1=e.sent,e.t0=0===e.t1;case 12:if(e.t0)return console.log("bootstrapping events"),_=n.events().reduce(function(e,r){return e.sequence[r.aggregateId]=(e.sequence[r.aggregateId]||0)+1,e.events.push(_objectSpread({},r,{actor:"bootstrap",sequenceNumber:e.sequence[r.aggregateId]})),e},{sequence:{},events:[]}).events,e.next=17,m.record(_.map(function(e){return _objectSpread({},e,{actor:"bootstrap"})}));e.next=17;break;case 17:return v=Object.entries(o).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=new _nodeCqrsLib.Repository({eventStore:m,aggregateType:n,constructor:a.aggregate,snapshots:i("eventStore").snapshots}),e},{}),y=Object.entries(o).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return new _commandExecutor.default({name:t,handlers:f(n.handlers),repository:v[t]})}),e.next=21,_authStore.default.create({db:t,identityMapper:p});case 21:if(b=e.sent,e.t2=null==n?void 0:n.users,e.t2)return e.next=26,b.count();e.next=28;break;case 26:e.t3=e.sent,e.t2=0===e.t3;case 28:if(!e.t2){e.next=56;break}console.log("bootstrapping users"),h=!(w=!0),g=void 0,e.prev=33,S=n.users()[Symbol.iterator]();case 35:if(w=(q=S.next()).done){e.next=42;break}return R=q.value,e.next=39,b.addUser(R);case 39:w=!0,e.next=35;break;case 42:e.next=48;break;case 44:e.prev=44,e.t4=e.catch(33),h=!0,g=e.t4;case 48:e.prev=48,e.prev=49,w||null==S.return||S.return();case 51:if(e.prev=51,h)throw g;e.next=54;break;case 54:return e.finish(51);case 55:return e.finish(48);case 56:return x=new _authTokenMapper.default({authStore:b,secret:i.decrypt(i("authentication").secret),expiration:i("authentication").expiration,identityMapper:p}),a.register("systemIdentity",function(){return x.sign(_nodeCqrsLib.Identity.system)}),_awsSdk.default.config.update({region:i("aws").SNS_SES_region,accessKeyId:i("aws").AccessKey&&i.decrypt(i("aws").AccessKey),secretAccessKey:i("aws").SecretAccessKey&&i.decrypt(i("aws").SecretAccessKey)}),k=new _services.AwsSNS({applicationArns:{ios:i("aws").IOS_APP_ARN,android:i("aws").ANDROID_APP_ARN}}),a.register("PushNotifications",function(){return k}),C={sendEmail:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.recipient,n=r.subject,a=r.body,console.log("Simulating Sending Email\n  ---------------------\n  ".concat(n,"\n  To: ").concat(t,"\n  ---------------------\n  ").concat(a.text));case 2:case"end":return e.stop()}},e,this)}));return function(e){return r.apply(this,arguments)}}()},A=new _services.Emailer({sender:s||((i("aws").Test||[]).includes("email")?C:new _services.AwsEmailSender({awsSes:new _awsSdk.default.SES,from:i("aws").SES_Source})),templateLibrary:u}),a.register("Emailer",function(){return A}),D=new _services.SecretCodes,a.register("SecretCodes",function(){return D}),a.register("AuthStore",function(){return b}),E=new _domainCommandDeliverer.default(y),T=new _nodeCqrsLib.RealWorldClock,e.next=71,j(i("scheduledCommands").store);case 71:return e.next=73,e.sent.createChannel();case 73:return P=e.sent,O=new _nodeCqrsLib.RabbitScheduler({channel:P,clock:T,deliverer:E}),H=new _domainServices.default({commandScheduler:O,repositories:v,clock:T}),a.register("DomainServices",function(){return H}),I=new _commandRouter.default({webHandler:new _webCommandHandler.default(E)}),M=new _passwordCommandHandler.default(E,b),L=new _authenticationRouter.default({passport:_koaPassport.default,authStore:b,decorateUser:d,authTokenMapper:x,passwordHandler:M}),N=new _injectEventRouter.default({repositories:v,eventStore:m}),e.abrupt("return",{routers:{command:I,auth:L,injectEvent:N},middleware:{identity:new _identityMiddleware.default(x).inject},authStore:b,repositories:v});case 82:case"end":return e.stop()}},e,this,[[33,44,48,56],[49,,51,55]])}));return function(e){return r.apply(this,arguments)}}());
//# sourceMappingURL=maps/initialize.js.map
