"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk")),_koaPassport=_interopRequireDefault(require("koa-passport")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_authenticationRouter=_interopRequireDefault(require("./routing/authenticationRouter")),_commandRouter=_interopRequireDefault(require("./routing/commandRouter")),_injectEventRouter=_interopRequireDefault(require("./routing/injectEventRouter")),_taskSchedulerRouter=_interopRequireDefault(require("./routing/taskSchedulerRouter")),_identityMiddleware=_interopRequireDefault(require("./routing/identityMiddleware")),_commandExecutor=_interopRequireDefault(require("./commandHandling/commandExecutor")),_webCommandHandler=_interopRequireDefault(require("./commandHandling/webCommandHandler")),_passwordCommandHandler=_interopRequireDefault(require("./commandHandling/passwordCommandHandler")),_domainCommandDeliverer=_interopRequireDefault(require("./commandHandling/domainCommandDeliverer")),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=_interopRequireDefault(require("./auth/authTokenMapper")),_authStore=_interopRequireDefault(require("./auth/authStore")),_nodeCqrsLib=require("@facetdev/node-cqrs-lib"),_domainServices=_interopRequireDefault(require("./scheduling/domainServices"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],n=!0,a=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(t.push(i.value),!r||t.length!==r);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,r,t,n,a,o,i){try{var u=e[o](i),s=u.value}catch(e){return void t(e)}u.done?r(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(u){return function(){var e=this,i=arguments;return new Promise(function(r,t){var n=u.apply(e,i);function a(e){asyncGeneratorStep(n,r,t,a,o,"next",e)}function o(e){asyncGeneratorStep(n,r,t,a,o,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var Services=function e(){_classCallCheck(this,e)};_defineProperty(exports.default=Services,"initialize",function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a,o,i,u,s,c,l,d,p,f,v,m,_,y,g,b,h,w,S,k,q,R,x,j,C,T,E,O,D,A,P,M,H,I,K,L,G,U,W,z,F,N,B,J;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _=function(e){return Object.entries(e).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return{name:t,handler:function(){return a.resolve(n)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},a=r.container,o=r.config,i=r.db,u=r.fcmKey,s=r.bootstrap,c=r.domain,l=r.emailTemplates,d=r.emailSender,p=r.decorateUser,f=void 0===p?function(e){return e}:p,v=r.identityMapper,m=void 0===v?function(e){return new _nodeCqrsLib.Identity(e)}:v,e.next=4,_eventing.EventStoreInitializer.assureEventsTable(i);case 4:if(y=new _eventing.EventStore({db:i,mapper:new _eventing.EventMapper(Object.entries(c).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=a.events,e},{}))}),e.t0=null==s?void 0:s.events,e.t0)return e.next=9,y.count();e.next=11;break;case 9:e.t1=e.sent,e.t0=0===e.t1;case 11:if(e.t0)return console.log("bootstrapping events"),g=s.events().reduce(function(e,r){return e.sequence[r.aggregateId]=(e.sequence[r.aggregateId]||0)+1,e.events.push(_objectSpread({},r,{actor:"bootstrap",sequenceNumber:e.sequence[r.aggregateId]})),e},{sequence:{},events:[]}).events,e.next=16,y.record(g.map(function(e){return _objectSpread({},e,{actor:"bootstrap"})}));e.next=16;break;case 16:return b=Object.entries(c).reduce(function(e,r){var t=_slicedToArray(r,2),n=t[0],a=t[1];return e[n]=new _nodeCqrsLib.Repository({eventStore:y,aggregateType:n,constructor:a.aggregate,snapshots:o("eventStore").snapshots}),e},{}),h=Object.entries(c).map(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return new _commandExecutor.default({name:t,handlers:_(n.handlers),repository:b[t]})}),e.next=20,_authStore.default.create({db:i,identityMapper:m});case 20:if(w=e.sent,e.t2=null==s?void 0:s.users,e.t2)return e.next=25,w.count();e.next=27;break;case 25:e.t3=e.sent,e.t2=0===e.t3;case 27:if(!e.t2){e.next=55;break}console.log("bootstrapping users"),k=!(S=!0),q=void 0,e.prev=32,R=s.users()[Symbol.iterator]();case 34:if(S=(x=R.next()).done){e.next=41;break}return j=x.value,e.next=38,w.addUser(j);case 38:S=!0,e.next=34;break;case 41:e.next=47;break;case 43:e.prev=43,e.t4=e.catch(32),k=!0,q=e.t4;case 47:e.prev=47,e.prev=48,S||null==R.return||R.return();case 50:if(e.prev=50,k)throw q;e.next=53;break;case 53:return e.finish(50);case 54:return e.finish(47);case 55:if(C=new _authTokenMapper.default({authStore:w,secret:o.decrypt(o("authentication").secret),expiration:o("authentication").expiration,identityMapper:m}),a.register("AuthTokenMapper",function(){return C}),a.register("systemIdentity",function(){return C.sign(_nodeCqrsLib.Identity.system)}),_awsSdk.default.config.update({region:o("aws").SNS_SES_region,accessKeyId:o("aws").AccessKey&&o.decrypt(o("aws").AccessKey),secretAccessKey:o("aws").SecretAccessKey&&o.decrypt(o("aws").SecretAccessKey)}),T={sendEmail:function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.recipient,n=r.subject,a=r.body,console.log("Simulating Sending Email\n  ---------------------\n  ".concat(n,"\n  To: ").concat(t,"\n  ---------------------\n  ").concat(a.text));case 2:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}()},E=new _services.Emailer({sender:d||((o("aws").Test||[]).includes("email")?T:new _services.AwsEmailSender({awsSes:new _awsSdk.default.SES,from:o("aws").SES_Source})),templateLibrary:l}),a.register("Emailer",function(){return E}),O=new _services.SecretCodes,a.register("SecretCodes",function(){return O}),a.register("AuthStore",function(){return w}),D=new _domainCommandDeliverer.default(h),A=new _nodeCqrsLib.RealWorldClock,P=null===(t=o("google").tasks)||void 0===t?void 0:t.deliveryRoot,"dev"===process.env.ConfigurationPrecedence)return e.prev=69,e.next=72,(0,_nodeFetch.default)("http://ngrok:4040/api/tunnels",{method:"GET",headers:{"Content-Type":"application/json"}});e.next=83;break;case 72:return L=e.sent,e.next=75,L.json();case 75:G=e.sent,console.log("setting Gcloud Task callback root to:",null===(M=G.tunnels)||void 0===M||null===(H=M[0])||void 0===H?void 0:H.public_url),P=null===(I=G.tunnels)||void 0===I||null===(K=I[0])||void 0===K?void 0:K.public_url,e.next=83;break;case 80:e.prev=80,e.t5=e.catch(69),console.log("lookup of ngrok in dev environment failed");case 83:return U=new _nodeCqrsLib.TaskScheduler(_objectSpread({},o("google").tasks,{rootUrl:P,deliveryPath:"services/task/deliver",secret:o.decrypt(o("authentication").secret),credentials:{private_key:u,client_email:o("google").serviceAccounts.firebase.client_email,email:o("google").serviceAccounts.firebase.client_email}})),W=new _domainServices.default({commandScheduler:U,commandExecuter:D,repositories:b,clock:A}),a.register("DomainServices",function(){return W}),z=new _commandRouter.default({webHandler:new _webCommandHandler.default(D)}),F=new _passwordCommandHandler.default(D,w),N=new _authenticationRouter.default({passport:_koaPassport.default,authStore:w,decorateUser:f,authTokenMapper:C,passwordHandler:F,speakeasyConfig:(null===(n=o("authentication"))||void 0===n?void 0:n.speakeasyConfig)||{}}),B=new _injectEventRouter.default({repositories:b,eventStore:y}),J=new _taskSchedulerRouter.default({deliverer:D,secret:o.decrypt(o("authentication").secret)}),e.abrupt("return",{routers:{command:z,auth:N,injectEvent:B,task:J},middleware:{identity:new _identityMiddleware.default(C).inject},aws:_awsSdk.default,authStore:w,authTokenMapper:C,emailer:E,repositories:b});case 92:case"end":return e.stop()}},e,null,[[32,43,47,55],[48,,50,54],[69,80]])}));return function(e){return r.apply(this,arguments)}}());
//# sourceMappingURL=maps/initialize.js.map
