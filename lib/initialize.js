"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_entries=require("babel-runtime/core-js/object/entries"),_entries2=_interopRequireDefault(_entries),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_awsSdk=require("aws-sdk"),_awsSdk2=_interopRequireDefault(_awsSdk),_koaPassport=require("koa-passport"),_koaPassport2=_interopRequireDefault(_koaPassport),_authenticationRouter=require("./routing/authenticationRouter"),_authenticationRouter2=_interopRequireDefault(_authenticationRouter),_commandRouter=require("./routing/commandRouter"),_commandRouter2=_interopRequireDefault(_commandRouter),_uploadRouter=require("./routing/uploadRouter"),_uploadRouter2=_interopRequireDefault(_uploadRouter),_nodeCqrsLib=require("node-cqrs-lib"),_identityMiddleware=require("./routing/identityMiddleware"),_identityMiddleware2=_interopRequireDefault(_identityMiddleware),_commandExecutor=require("./commandHandling/commandExecutor"),_commandExecutor2=_interopRequireDefault(_commandExecutor),_webCommandHandler=require("./commandHandling/webCommandHandler"),_webCommandHandler2=_interopRequireDefault(_webCommandHandler),_passwordCommandHandler=require("./commandHandling/passwordCommandHandler"),_passwordCommandHandler2=_interopRequireDefault(_passwordCommandHandler),_domainCommandDeliverer=require("./commandHandling/domainCommandDeliverer"),_domainCommandDeliverer2=_interopRequireDefault(_domainCommandDeliverer),_eventing=require("./eventing"),_services=require("./services"),_authTokenMapper=require("./auth/authTokenMapper"),_authTokenMapper2=_interopRequireDefault(_authTokenMapper),_authStore=require("./auth/authStore"),_authStore2=_interopRequireDefault(_authStore),_scheduledCommandStore=require("./scheduling/scheduledCommandStore"),_scheduledCommandStore2=_interopRequireDefault(_scheduledCommandStore),_scheduledCommandStoreInitializer=require("./scheduling/scheduledCommandStoreInitializer"),_scheduledCommandStoreInitializer2=_interopRequireDefault(_scheduledCommandStoreInitializer),_domainServices=require("./scheduling/domainServices"),_domainServices2=_interopRequireDefault(_domainServices),Services=function e(){(0,_classCallCheck3.default)(this,e)};Services.initialize=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,o,i,u,d,s,l,c,_,m,p,f,w,S,h,q,g,v,C=r.container,R=r.config,b=r.db,y=r.domain,k=r.emailTemplates,D=r.decorateUser;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=function(e){return(0,_entries2.default)(e).map(function(e){var r=e[0],t=e[1];return{name:r,handler:function(){return C.resolve(t)}}}).reduce(function(e,r){return e[r.name]=r.handler,e},{})},e.next=3,_eventing.EventStoreInitializer.assureEventsTable(b);case 3:return e.next=5,_scheduledCommandStoreInitializer2.default.assureTables(b);case 5:return n=(0,_entries2.default)(y).reduce(function(e,r){var t=r[0],n=r[1];return e[t]=new _nodeCqrsLib.Repository({eventStore:new _eventing.EventStore({aggregate:t,db:b,mapper:new _eventing.EventMapper(t,n.events)}),aggregate:n.aggregate}),e},{}),a=(0,_entries2.default)(y).map(function(e){var r=e[0],a=e[1];return new _commandExecutor2.default({name:r,handlers:t(a.handlers),repository:n[r]})}),o=(0,_entries2.default)(y).reduce(function(e,r){var t=r[0],n=r[1];return e[t]=n.commands,e},{}),e.next=10,_authStore2.default.create(b);case 10:return i=e.sent,u=new _authTokenMapper2.default({authStore:i,secret:R.decrypt(R("authentication").secret),expiration:R("authentication").expiration}),C.register("systemIdentity",function(){return u.sign(_nodeCqrsLib.Identity.system)}),_awsSdk2.default.config.update({region:R("aws").SNS_SES_region,accessKeyId:R("aws").AccessKey&&R.decrypt(R("aws").AccessKey),secretAccessKey:R("aws").SecretAccessKey&&R.decrypt(R("aws").SecretAccessKey)}),d=new _services.AwsSNS({applicationArns:{ios:R("aws").IOS_APP_ARN,android:R("aws").ANDROID_APP_ARN}}),C.register("PushNotifications",function(){return d}),s={sendEmail:function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t=r.recipient,n=r.subject,a=r.body;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("Simulating Sending Email\n  ---------------------\n  "+n+"\n  To: "+t+"\n  ---------------------\n  "+a.text);case 1:case"end":return e.stop()}},e,void 0)}));return function(r){return e.apply(this,arguments)}}()},l=new _services.Emailer({sender:(R("aws").Test||[]).includes("email")?new _services.AwsEmailSender({awsSes:new _awsSdk2.default.SES,from:R("aws").SES_Source}):s,templateLibrary:k}),C.register("Emailer",function(){return l}),c=new _services.SecretCodes,C.register("SecretCodes",function(){return c}),C.register("AuthStore",function(){return i}),_=new _domainCommandDeliverer2.default(a),m=new _nodeCqrsLib.RealWorldClock,p=new _scheduledCommandStore2.default(b,function(e,r){return o[e][r]},function(){return new _nodeCqrsLib.RealWorldClock}),f=new _nodeCqrsLib.CommandScheduler({store:p,clock:m,deliverer:_}),w=new _nodeCqrsLib.CommandScheduleTrigger(f,m,1e3),w.start(),S=new _domainServices2.default({commandScheduler:f,repositories:n,clock:m}),C.register("DomainServices",function(){return S}),h=new _uploadRouter2.default({S3_Bucket:R("aws").S3_Bucket}),q=new _commandRouter2.default({webHandler:new _webCommandHandler2.default(_)}),g=new _passwordCommandHandler2.default(_,i),v=new _authenticationRouter2.default({passport:_koaPassport2.default,authStore:i,decorateUser:D,authTokenMapper:u,passwordHandler:g}),e.abrupt("return",{routers:{upload:h,command:q,auth:v},middleware:{identity:new _identityMiddleware2.default(u).inject},authStore:i,repositories:n});case 35:case"end":return e.stop()}},e,void 0)}));return function(r){return e.apply(this,arguments)}}(),exports.default=Services,module.exports=exports.default;
//# sourceMappingURL=maps/initialize.js.map
