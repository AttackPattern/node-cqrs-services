"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){function o(e,t){try{var r=u[e](t),o=r.value}catch(e){return void a(e)}r.done?n(o):Promise.resolve(o).then(s,i)}function s(e){o("next",e)}function i(e){o("throw",e)}var u=e.apply(t,r);s()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _eachSeries=_interopRequireDefault(require("async/eachSeries")),_bookshelf=_interopRequireDefault(require("bookshelf")),EventStore=function e(t){var r=t.aggregate,n=void 0===r?"":r,a=t.mapper,o=t.db;_classCallCheck(this,e),_initialiseProps.call(this),this.aggregate=n,this.mapper=a,this.Event=(0,_bookshelf.default)(o.knex("eventstore")).Model.extend({tableName:"events"}),this.Snapshot=(0,_bookshelf.default)(o.knex("eventstore")).Model.extend({tableName:"snapshots"})};exports.default=EventStore;var _initialiseProps=function(){var e=this;Object.defineProperty(this,"getEvents",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.Event.where({aggregate:e.aggregate,aggregateId:r}).orderBy("sequenceNumber","asc").query();case 3:return t.t0=function(t){return e.mapper.fromStoredEvent(t)},t.t1=t.sent.map(t.t0),t.t2=JSON,t.next=8,e.Snapshot.where({aggregate:e.aggregate,aggregateId:r}).orderBy("version","desc").query();case 8:if(t.t5=n=t.sent[0],t.t4=null===t.t5,t.t4){t.next=12;break}t.t4=void 0===n;case 12:if(!t.t4){t.next=16;break}t.t6=void 0,t.next=17;break;case 16:t.t6=n.body;case 17:if(t.t3=t.t6,t.t3){t.next=20;break}t.t3="{}";case 20:return t.t7=t.t3,t.t8=t.t2.parse.call(t.t2,t.t7),t.abrupt("return",{events:t.t1,snapshot:t.t8});case 25:throw t.prev=25,t.t9=t.catch(0),console.log("Error loading events",t.t9),t.t9;case 29:case"end":return t.stop()}},t,this,[[0,25]])}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"record",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,_eachSeries.default)(r,function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.recordEvent(r);case 2:n();case 3:case"end":return t.stop()}},t,this)}));return function(e,r){return t.apply(this,arguments)}}());case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"recordEvent",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.mapper.toStoredEvent(r),t.prev=1,t.t0=e.mapper,t.next=5,new e.Event(n).save();case 5:return t.t1=t.sent.toJSON(),t.abrupt("return",t.t0.fromStoredEvent.call(t.t0,t.t1));case 9:throw t.prev=9,t.t2=t.catch(1),console.log("Failed to save event",t.t2),t.t2;case 13:case"end":return t.stop()}},t,this,[[1,9]])}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"saveSnapshot",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=t.aggregate;case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()})};
//# sourceMappingURL=../maps/eventing/eventStore.js.map
