"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){function o(e,t){try{var r=u[e](t),o=r.value}catch(e){return void a(e)}r.done?n(o):Promise.resolve(o).then(s,i)}function s(e){o("next",e)}function i(e){o("throw",e)}var u=e.apply(t,r);s()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _eachSeries=_interopRequireDefault(require("async/eachSeries")),_bookshelf=_interopRequireDefault(require("bookshelf")),EventStore=function e(t){var r=t.aggregate,n=void 0===r?"":r,a=t.mapper,o=t.db;_classCallCheck(this,e),_initialiseProps.call(this),this.aggregate=n,this.mapper=a,this.Event=(0,_bookshelf.default)(o.knex("eventstore")).Model.extend({tableName:"events"}),this.Snapshot=(0,_bookshelf.default)(o.knex("eventstore")).Model.extend({tableName:"snapshots"})};exports.default=EventStore;var _initialiseProps=function(){var e=this;Object.defineProperty(this,"getEvents",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){var n,a,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.Snapshot.where({aggregate:e.aggregate,aggregateId:r}).orderBy("version","desc").fetch();case 3:if(t.t1=n=t.sent,t.t0=null===t.t1,t.t0){t.next=7;break}t.t0=void 0===n;case 7:if(!t.t0){t.next=11;break}t.t2=void 0,t.next=12;break;case 11:t.t2=n.toJSON();case 12:return a=t.t2,o=e.Event.where({aggregate:e.aggregate}).where({aggregateId:r}),a&&(o=o.where("sequenceNumber",">",a.version)),t.next=17,o.orderBy("sequenceNumber","asc").query();case 17:return t.t3=function(t){return e.mapper.fromStoredEvent(t)},t.t4=t.sent.map(t.t3),t.t5=a&&{version:a.version,body:JSON.parse(a.body)},t.abrupt("return",{events:t.t4,snapshot:t.t5});case 23:throw t.prev=23,t.t6=t.catch(0),console.log("Error loading events",t.t6),t.t6;case 27:case"end":return t.stop()}},t,this,[[0,23]])}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"record",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,_eachSeries.default)(r,function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.recordEvent(r);case 2:n();case 3:case"end":return t.stop()}},t,this)}));return function(e,r){return t.apply(this,arguments)}}());case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"recordEvent",{configurable:!0,enumerable:!0,writable:!0,value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.mapper.toStoredEvent(r),t.prev=1,t.t0=e.mapper,t.next=5,new e.Event(n).save();case 5:return t.t1=t.sent.toJSON(),t.abrupt("return",t.t0.fromStoredEvent.call(t.t0,t.t1));case 9:throw t.prev=9,t.t2=t.catch(1),console.log("Failed to save event",t.t2),t.t2;case 13:case"end":return t.stop()}},t,this,[[1,9]])}));return function(e){return t.apply(this,arguments)}}()}),Object.defineProperty(this,"saveSnapshot",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=t.aggregate;case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()})};
//# sourceMappingURL=../maps/eventing/eventStore.js.map
